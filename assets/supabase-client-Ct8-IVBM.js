import{createClient as S}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const m=document.createElement("link").relList;if(m&&m.supports&&m.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))d(a);new MutationObserver(a=>{for(const t of a)if(t.type==="childList")for(const c of t.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&d(c)}).observe(document,{childList:!0,subtree:!0});function i(a){const t={};return a.integrity&&(t.integrity=a.integrity),a.referrerPolicy&&(t.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?t.credentials="include":a.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function d(a){if(a.ep)return;a.ep=!0;const t=i(a);fetch(a.href,t)}})();const Z="https://iwikwbjsznjuefvuemdb.supabase.co",x="sb_publishable_nnsBbg8U3oU3P8esLDvZTw_XOfU0ez7",p=S(Z,x);async function E(e){const m=new Date(e.selectedDate);m.setHours(0,0,0,0);const i=new Date,d=new Date(i.getFullYear(),i.getMonth(),i.getDate());let a=!1;const t=i.getHours(),c=i.getMinutes();m.getTime()===d.getTime()?e.shift==="sabah"?a=t<17||t===17&&c<=30:e.shift==="aksam"&&(t>=16&&t<=23||t===0&&c<=59||t===1&&c===0?a=!0:a=!1):a=!1;async function v(s){try{const{data:o,error:l}=await p.from("daily_reports").select("date").eq("cashier_id",s).order("date",{ascending:!1}).limit(14);if(l||!o)return!1;const f=[...new Set(o.map(u=>u.date))].sort().reverse();if(f.length<7)return!1;for(let u=0;u<6;u++){const D=new Date(f[u]),M=new Date(f[u+1]);if(Math.floor((D-M)/864e5)!==1)return!1}return!0}catch(o){return console.error("Ardışık gün kontrolü hatası:",o),!1}}const _=await v(e.cashierId),h=(e.rumeliZ1&&parseFloat(e.rumeliZ1)>0||e.rumeliZ2&&parseFloat(e.rumeliZ2)>0||e.balikEkmek&&parseFloat(e.balikEkmek)>0||e.dondurma&&parseFloat(e.dondurma)>0||e.dondurmaZ&&parseFloat(e.dondurmaZ)>0)&&[e.gida,e.kahvalti,e.kahve,e.meyveSuyu,e.sicakIcecek,e.sogukIcecek,e.tatli].filter(s=>s&&parseFloat(s)>0).length>=3,g=h;let n=10;a?n+=10:n-=5,h&&(n+=10),_&&(n+=25),console.log("Puan Detayları:",{temelPuan:10,zamanindaBonus:a?10:-5,eksiksizBonus:h?10:0,ardisikBonus:_?25:0,toplamPuan:n,isOnTime:a,hasCompleteData:h,has7DayStreak:_});let r={rumeli_z1:parseFloat(e.rumeliZ1)||0,rumeli_z2:parseFloat(e.rumeliZ2)||0,balik_ekmek:parseFloat(e.balikEkmek)||0,dondurma:parseFloat(e.dondurma)||parseFloat(e.dondurmaZ)||0,gida:parseFloat(e.gida)||0,kahvalti:parseFloat(e.kahvalti)||0,kahve:parseFloat(e.kahve)||0,meyvesuyu:parseFloat(e.meyveSuyu)||0,sicak_icecek:parseFloat(e.sicakIcecek)||0,soguk_icecek:parseFloat(e.sogukIcecek)||0,tatli:parseFloat(e.tatli)||0,salata:parseFloat(e.salata)||0,dondurma_kategori:parseFloat(e.dondurmaKategori)||0};if(e.shift==="aksam"){const{data:s,error:o}=await p.from("daily_reports").select("*").eq("date",e.selectedDate).eq("kasa",e.kasa).eq("shift","sabah").single();s&&!o&&(console.log("Sabah verisi bulundu, bireysel performans hesaplanıyor..."),r.rumeli_z1=Math.max(0,(r.rumeli_z1||0)-(parseFloat(s.rumeli_z1)||0)),r.rumeli_z2=Math.max(0,(r.rumeli_z2||0)-(parseFloat(s.rumeli_z2)||0)),r.balik_ekmek=Math.max(0,(r.balik_ekmek||0)-(parseFloat(s.balik_ekmek)||0)),r.dondurma=Math.max(0,(r.dondurma||0)-(parseFloat(s.dondurma)||0)),r.gida=Math.max(0,(r.gida||0)-(parseFloat(s.gida)||0)),r.kahvalti=Math.max(0,(r.kahvalti||0)-(parseFloat(s.kahvalti)||0)),r.kahve=Math.max(0,(r.kahve||0)-(parseFloat(s.kahve)||0)),r.meyvesuyu=Math.max(0,(r.meyvesuyu||0)-(parseFloat(s.meyvesuyu)||0)),r.sicak_icecek=Math.max(0,(r.sicak_icecek||0)-(parseFloat(s.sicak_icecek)||0)),r.soguk_icecek=Math.max(0,(r.soguk_icecek||0)-(parseFloat(s.soguk_icecek)||0)),r.tatli=Math.max(0,(r.tatli||0)-(parseFloat(s.tatli)||0)),r.salata=Math.max(0,(r.salata||0)-(parseFloat(s.salata)||0)),r.dondurma_kategori=Math.max(0,(r.dondurma_kategori||0)-(parseFloat(s.dondurma_kategori)||0)))}const b=Math.max(0,r.rumeli_z1+r.rumeli_z2+r.balik_ekmek+r.dondurma),z=(parseFloat(e.rumeliZ1)||0)+(parseFloat(e.rumeliZ2)||0)+(parseFloat(e.balikEkmek)||0)+(parseFloat(e.dondurma)||parseFloat(e.dondurmaZ)||0),k={date:e.selectedDate,cashier_id:e.cashierId,kasa:e.kasa,shift:e.shift,register_name:"Rumeli İskelesi",rumeli_z1:parseFloat(e.rumeliZ1)||0,rumeli_z2:parseFloat(e.rumeliZ2)||0,balik_ekmek:parseFloat(e.balikEkmek)||0,dondurma:parseFloat(e.dondurma)||parseFloat(e.dondurmaZ)||0,dondurma_adet:parseFloat(e.dondurmaAdet)||0,gida:parseFloat(e.gida)||0,kahve:parseFloat(e.kahve)||0,sicak_icecek:parseFloat(e.sicakIcecek)||0,soguk_icecek:parseFloat(e.sogukIcecek)||0,tatli:parseFloat(e.tatli)||0,meyvesuyu:parseFloat(e.meyveSuyu)||0,kahvalti:parseFloat(e.kahvalti)||0,salata:parseFloat(e.salata)||0,dondurma_kategori:parseFloat(e.dondurmaKategori)||0,depo:parseFloat(e.depo)||0,notlar:e.notlar||"",total_revenue:z,individual_revenue:b,entry_time:i.toISOString(),is_on_time:a,points_earned:n},{data:F,error:y}=await p.from("daily_reports").insert([k]).select().single();if(y)return{data:null,error:y};const w={cashier_id:e.cashierId,report_id:F.id,shift:e.shift,kasa:e.kasa,entry_time:i.toISOString(),is_on_time:a,is_complete:g,points_earned:n,revenue_amount:k.rumeli_z1+k.rumeli_z2+k.balik_ekmek+k.dondurma+k.salata};await p.from("entry_history").insert([w]);try{const{data:s}=await p.from("daily_reports").select("points_earned").eq("cashier_id",e.cashierId),o=(s||[]).reduce((f,u)=>f+(parseInt(u.points_earned)||0),0);let l="yeni";o>=1e3?l="efsane":o>=500?l="elmas":o>=300?l="altin":o>=150?l="gumus":o>=50&&(l="bronz"),await p.from("cashiers").update({total_points:o,badge_level:l}).eq("id",e.cashierId),console.log("Kasiyer puanı senkronize edildi:",{totalPoints:o,badgeLevel:l})}catch(s){console.error("Puan senkronizasyonu hatası:",s)}return{data:{...F,pointsEarned:n,isOnTime:a,isComplete:g},error:null}}export{E as i,p as s};
