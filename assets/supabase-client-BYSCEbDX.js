import{createClient as E}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))d(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&d(u)}).observe(document,{childList:!0,subtree:!0});function i(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function d(a){if(a.ep)return;a.ep=!0;const s=i(a);fetch(a.href,s)}})();const O="https://iwikwbjsznjuefvuemdb.supabase.co",P="sb_publishable_nnsBbg8U3oU3P8esLDvZTw_XOfU0ez7",k=E(O,P);async function A(e){const c=new Date(e.selectedDate);c.setHours(0,0,0,0);const i=new Date,d=new Date(i.getFullYear(),i.getMonth(),i.getDate());let a=!1;const s=i.getHours(),u=i.getMinutes();c.getTime()===d.getTime()?e.shift==="sabah"?a=s<17||s===17&&u<=30:e.shift==="aksam"&&(s>=16&&s<=23||s===0&&u<=59||s===1&&u===0?a=!0:a=!1):a=!1;async function w(t){try{const o=new Date,l=new Date(o.getFullYear(),o.getMonth(),1).toISOString().split("T")[0],F=new Date(o.getFullYear(),o.getMonth()+1,0).toISOString().split("T")[0],{data:h,error:I}=await k.from("daily_reports").select("date").eq("cashier_id",t).gte("date",l).lte("date",F).order("date",{ascending:!1});if(I||!h||h.length<7)return!1;const _=[...new Set(h.map(p=>p.date))].sort().reverse();if(_.length<7)return!1;let y=1;for(let p=0;p<_.length-1;p++){const Z=new Date(_[p]),x=new Date(_[p+1]);if(Math.floor((Z-x)/(1e3*60*60*24))===1){if(y++,y>=7)return!0}else y=1}return!1}catch(o){return console.error("Ardışık gün kontrolü hatası:",o),!1}}const g=await w(e.cashierId),f=(e.rumeliZ1&&parseFloat(e.rumeliZ1)>0||e.rumeliZ2&&parseFloat(e.rumeliZ2)>0||e.balikEkmek&&parseFloat(e.balikEkmek)>0||e.dondurma&&parseFloat(e.dondurma)>0||e.dondurmaZ&&parseFloat(e.dondurmaZ)>0)&&[e.gida,e.kahvalti,e.kahve,e.meyveSuyu,e.sicakIcecek,e.sogukIcecek,e.tatli].filter(t=>t&&parseFloat(t)>0).length>=3,v=f;let n=10;a?n+=10:n-=5,f&&(n+=10),g&&(n+=25),console.log("Puan Detayları:",{temelPuan:10,zamanindaBonus:a?10:-5,eksiksizBonus:f?10:0,ardisikBonus:g?25:0,toplamPuan:n,isOnTime:a,hasCompleteData:f,has7DayStreak:g});let r={rumeli_z1:parseFloat(e.rumeliZ1)||0,rumeli_z2:parseFloat(e.rumeliZ2)||0,balik_ekmek:parseFloat(e.balikEkmek)||0,dondurma:parseFloat(e.dondurma)||parseFloat(e.dondurmaZ)||0,gida:parseFloat(e.gida)||0,kahvalti:parseFloat(e.kahvalti)||0,kahve:parseFloat(e.kahve)||0,meyvesuyu:parseFloat(e.meyveSuyu)||0,sicak_icecek:parseFloat(e.sicakIcecek)||0,soguk_icecek:parseFloat(e.sogukIcecek)||0,tatli:parseFloat(e.tatli)||0,salata:parseFloat(e.salata)||0,dondurma_kategori:parseFloat(e.dondurmaKategori)||0};if(e.shift==="aksam"){const{data:t,error:o}=await k.from("daily_reports").select("*").eq("date",e.selectedDate).eq("kasa",e.kasa).eq("shift","sabah").single();t&&!o&&(console.log("Sabah verisi bulundu, bireysel performans hesaplanıyor..."),r.rumeli_z1=Math.max(0,(r.rumeli_z1||0)-(parseFloat(t.rumeli_z1)||0)),r.rumeli_z2=Math.max(0,(r.rumeli_z2||0)-(parseFloat(t.rumeli_z2)||0)),r.balik_ekmek=Math.max(0,(r.balik_ekmek||0)-(parseFloat(t.balik_ekmek)||0)),r.dondurma=Math.max(0,(r.dondurma||0)-(parseFloat(t.dondurma)||0)),r.gida=Math.max(0,(r.gida||0)-(parseFloat(t.gida)||0)),r.kahvalti=Math.max(0,(r.kahvalti||0)-(parseFloat(t.kahvalti)||0)),r.kahve=Math.max(0,(r.kahve||0)-(parseFloat(t.kahve)||0)),r.meyvesuyu=Math.max(0,(r.meyvesuyu||0)-(parseFloat(t.meyvesuyu)||0)),r.sicak_icecek=Math.max(0,(r.sicak_icecek||0)-(parseFloat(t.sicak_icecek)||0)),r.soguk_icecek=Math.max(0,(r.soguk_icecek||0)-(parseFloat(t.soguk_icecek)||0)),r.tatli=Math.max(0,(r.tatli||0)-(parseFloat(t.tatli)||0)),r.salata=Math.max(0,(r.salata||0)-(parseFloat(t.salata)||0)),r.dondurma_kategori=Math.max(0,(r.dondurma_kategori||0)-(parseFloat(t.dondurma_kategori)||0)))}const z=Math.max(0,r.rumeli_z1+r.rumeli_z2+r.balik_ekmek+r.dondurma),S=(parseFloat(e.rumeliZ1)||0)+(parseFloat(e.rumeliZ2)||0)+(parseFloat(e.balikEkmek)||0)+(parseFloat(e.dondurma)||parseFloat(e.dondurmaZ)||0),m={date:e.selectedDate,cashier_id:e.cashierId,kasa:e.kasa,shift:e.shift,register_name:"Rumeli İskelesi",rumeli_z1:parseFloat(e.rumeliZ1)||0,rumeli_z2:parseFloat(e.rumeliZ2)||0,balik_ekmek:parseFloat(e.balikEkmek)||0,dondurma:parseFloat(e.dondurma)||parseFloat(e.dondurmaZ)||0,dondurma_adet:parseFloat(e.dondurmaAdet)||0,gida:parseFloat(e.gida)||0,kahve:parseFloat(e.kahve)||0,sicak_icecek:parseFloat(e.sicakIcecek)||0,soguk_icecek:parseFloat(e.sogukIcecek)||0,tatli:parseFloat(e.tatli)||0,meyvesuyu:parseFloat(e.meyveSuyu)||0,kahvalti:parseFloat(e.kahvalti)||0,salata:parseFloat(e.salata)||0,dondurma_kategori:parseFloat(e.dondurmaKategori)||0,depo:parseFloat(e.depo)||0,notlar:e.notlar||"",total_revenue:S,individual_revenue:z,entry_time:i.toISOString(),is_on_time:a,points_earned:n},{data:b,error:D}=await k.from("daily_reports").insert([m]).select().single();if(D)return{data:null,error:D};const M={cashier_id:e.cashierId,report_id:b.id,shift:e.shift,kasa:e.kasa,entry_time:i.toISOString(),is_on_time:a,is_complete:v,points_earned:n,revenue_amount:m.rumeli_z1+m.rumeli_z2+m.balik_ekmek+m.dondurma+m.salata};await k.from("entry_history").insert([M]);try{const{data:t}=await k.from("daily_reports").select("points_earned").eq("cashier_id",e.cashierId),o=(t||[]).reduce((F,h)=>F+(parseInt(h.points_earned)||0),0);let l="yeni";o>=1e3?l="efsane":o>=500?l="elmas":o>=300?l="altin":o>=150?l="gumus":o>=50&&(l="bronz"),await k.from("cashiers").update({total_points:o,badge_level:l}).eq("id",e.cashierId),console.log("Kasiyer puanı senkronize edildi:",{totalPoints:o,badgeLevel:l})}catch(t){console.error("Puan senkronizasyonu hatası:",t)}return{data:{...b,pointsEarned:n,isOnTime:a,isComplete:v},error:null}}export{A as i,k as s};
